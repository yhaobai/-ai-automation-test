name: Python Interface Automation Tests
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    
jobs:
  run-python-tests:
    runs-on: ubuntu-latest  # 切换为Ubuntu环境
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5  # 升级到最新版，兼容性更好
        with:
          python-version: '3.9'
          cache: 'pip'  # 自动缓存pip依赖，加速安装
      
      - name: Update system packages (解决网络下载问题)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            gcc \
            python3-dev \
            libssl-dev \
            ca-certificates  # 确保SSL证书正常，避免HTTPS下载失败
        shell: bash
      
      - name: Install dependencies with retries
        run: |
          # 升级pip并配置国内镜像（解决下载慢/失败问题）
          python -m pip install --upgrade pip
          pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
          
          # 增加重试机制，应对网络波动
          pip install --retries 5 --timeout 60 -r requirements.txt
          
          # 锁定兼容版本（强制覆盖可能的冲突版本）
          pip install --retries 5 --timeout 60 \
            Flask==2.0.1 \
            Werkzeug==2.0.3 \
            PyJWT==2.3.0 \
            psutil==5.9.0
          
          # 验证安装结果
          echo "Installed versions:"
          pip list | grep -E "Flask|Werkzeug|PyJWT|psutil"
        shell: bash
      
      - name: Verify mock server file
        run: |
          if [ -f "api/mock_server.py" ]; then
              echo "✅ mock_server.py found at: $(realpath api/mock_server.py)"
              head -5 "api/mock_server.py"  # 显示前5行确认内容
              # 检查服务器端口配置
              grep "port=" "api/mock_server.py" || echo "⚠️ No port configuration found in mock_server.py"
          else
              echo "❌ mock_server.py not found"
              find . -type f -name "mock_server.py"  # 搜索文件位置
              exit 1
          fi
        shell: bash

      - name: Check and free port 3001
        run: |
          port=3001
          # 查找占用端口的进程并杀死
          pids=$(lsof -t -i:$port || true)
          if [ -n "$pids" ]; then
              echo "⚠️ Port $port is occupied by PIDs: $pids, killing them..."
              sudo kill -9 $pids
              sleep 2
              # 再次检查
              if lsof -i:$port; then
                  echo "❌ Failed to free port $port"
                  exit 1
              else
                  echo "✅ Port $port is now free"
              fi
          else
              echo "✅ Port $port is available"
          fi
        shell: bash

      - name: Start mock server (background mode)
        run: |
          stdout_log="mock_server_stdout.log"
          stderr_log="mock_server_stderr.log"
          combined_log="mock_server_combined.log"
          
          echo "Starting mock server..."
          
          # 启动服务器并记录日志
          python api/mock_server.py > "$stdout_log" 2> "$stderr_log" &
          server_pid=$!
          echo $server_pid > "mock_server.pid"
          echo "✅ Mock server started (PID: $server_pid)"
          
          # 合并日志
          cat "$stdout_log" "$stderr_log" > "$combined_log"
          
          # 健康检查（最多尝试30秒）
          retry_count=0
          max_retries=10
          while [ $retry_count -lt $max_retries ]; do
              retry_count=$((retry_count + 1))
              echo "[$retry_count/$max_retries] Checking server health..."
              
              if curl -s -m 5 "http://localhost:3001/health" > /dev/null; then
                  echo "✅ Server is ready!"
                  break
              else
                  echo "❌ Server not responding yet, retrying in 3 seconds..."
                  # 更新合并日志
                  cat "$stdout_log" "$stderr_log" > "$combined_log"
                  sleep 3
              fi
              
              # 检查服务器是否仍在运行
              if ! ps -p $server_pid > /dev/null; then
                  echo "❌ Mock server process crashed"
                  cat "$combined_log"  # 输出日志
                  exit 1
              fi
          done
          
          if [ $retry_count -ge $max_retries ]; then
              echo "❌ Server failed to respond after $max_retries attempts"
              cat "$combined_log"  # 输出日志
              
              # 检查端口状态
              if lsof -i:3001; then
                  echo "⚠️ Port 3001 is occupied"
              else
                  echo "⚠️ Port 3001 is not occupied (server not running)"
              fi
              
              exit 1
          fi
        shell: bash
        timeout-minutes: 5

      - name: Validate server accessibility
        run: |
          echo "Checking login endpoint..."
          response=$(curl -s -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"Admin123!"}' \
            "http://localhost:3001/api/v1/users/login")
          
          # 提取状态码（最后3位）
          status_code=${response: -3}
          # 提取响应内容（除最后3位）
          response_body=${response%???}
          
          echo "Response code: $status_code"
          echo "Response body: $response_body"
          
          if [ "$status_code" -eq 200 ]; then
              echo "✅ Login endpoint accessible"
          else
              echo "❌ Login endpoint failed with status code: $status_code"
              cat "mock_server_combined.log"
              exit 1
          fi
        shell: bash

      - name: Run interface automation tests
        env:
          PYTHONIOENCODING: utf-8
          MOCK_SERVER_URL: "http://localhost:3001"
        run: |
          python run_test.py --junitxml=test-results.xml
        shell: bash
      
      - name: Upload test results and logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results.xml
            mock_server_combined.log
      
      - name: Stop mock server
        if: always()
        run: |
          if [ -f "mock_server.pid" ]; then
              server_pid=$(cat "mock_server.pid")
              if ps -p $server_pid > /dev/null; then
                  kill -9 $server_pid
                  echo "✅ Mock server stopped (PID: $server_pid)"
              else
                  echo "ℹ️ Mock server already stopped"
              fi
          else
              # 备用方案：通过端口查找进程
              pids=$(lsof -t -i:3001 || true)
              if [ -n "$pids" ]; then
                  sudo kill -9 $pids
                  echo "✅ Mock server stopped (found via port 3001)"
              else
                  echo "ℹ️ No processes found listening on port 3001"
              fi
          fi
        shell: bash
      
      - name: Notify failure
        if: failure() && github.ref == 'refs/heads/master'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

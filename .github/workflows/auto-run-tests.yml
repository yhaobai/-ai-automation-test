name: Python Interface Automation Tests
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    
jobs:
  run-python-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Update system packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            gcc \
            python3-dev \
            libssl-dev \
            ca-certificates \
            openjdk-11-jre  
          wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz -O allure.tgz
          tar -zxvf allure.tgz -C /opt/
          echo "PATH=/opt/allure-2.25.0/bin:$PATH" >> $GITHUB_ENV
        shell: bash
      
      - name: Install dependencies with retries
        run: |
          python -m pip install --upgrade pip
          pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
          pip install --retries 5 --timeout 60 -r requirements.txt
          pip install --retries 5 --timeout 60 \
            Flask==2.0.1 \
            Werkzeug==2.0.3 \
            PyJWT==2.3.0 \
            psutil==5.9.0 \
            allure-pytest
          echo "Installed versions:"
          pip list | grep -E "Flask|Werkzeug|PyJWT|psutil|allure-pytest"
        shell: bash

      - name: Debug Allure path
        run: |
          echo "Current PATH: $PATH"
          echo "Allure directory: /opt/allure-2.25.0/bin"
          ls -al /opt/allure-2.25.0/bin
          which allure
        shell: bash

      - name: Verify Allure installation
        run: |
          echo "Checking Allure version..."
          allure --version
        shell: bash

      - name: Verify mock server file
        run: |
          if [ -f "api/mock_server.py" ]; then
              echo "âœ… mock_server.py found at: $(realpath api/mock_server.py)"
              head -5 "api/mock_server.py"
              grep "port=" "api/mock_server.py" || echo "âš ï¸ No port configuration found in mock_server.py"
          else
              echo "âŒ mock_server.py not found"
              find . -type f -name "mock_server.py"
              exit 1
          fi
        shell: bash

      - name: Check and free port 3001
        run: |
          port=3001
          pids=$(lsof -t -i:$port || true)
          if [ -n "$pids" ]; then
              echo "âš ï¸ Port $port is occupied by PIDs: $pids, killing them..."
              sudo kill -9 $pids
              sleep 2
              if lsof -i:$port; then
                  echo "âŒ Failed to free port $port"
                  exit 1
              else
                  echo "âœ… Port $port is now free"
              fi
          else
              echo "âœ… Port $port is available"
          fi
        shell: bash

      - name: Start mock server (background mode)
        run: |
          stdout_log="mock_server_stdout.log"
          stderr_log="mock_server_stderr.log"
          combined_log="mock_server_combined.log"
          
          echo "Starting mock server..."
          
          python api/mock_server.py > "$stdout_log" 2> "$stderr_log" &
          server_pid=$!
          echo $server_pid > "mock_server.pid"
          echo "âœ… Mock server started (PID: $server_pid)"
          
          cat "$stdout_log" "$stderr_log" > "$combined_log"
          
          retry_count=0
          max_retries=10
          while [ $retry_count -lt $max_retries ]; do
              retry_count=$((retry_count + 1))
              echo "[$retry_count/$max_retries] Checking server health..."
              
              if curl -s -m 5 "http://localhost:3001/health" > /dev/null; then
                  echo "âœ… Server is ready!"
                  break
              else
                  echo "âŒ Server not responding yet, retrying in 3 seconds..."
                  cat "$stdout_log" "$stderr_log" > "$combined_log"
                  sleep 3
              fi
              
              if ! ps -p $server_pid > /dev/null; then
                  echo "âŒ Mock server process crashed"
                  cat "$combined_log"
                  exit 1
              fi
          done
          
          if [ $retry_count -ge $max_retries ]; then
              echo "âŒ Server failed to respond after $max_retries attempts"
              cat "$combined_log"
              
              if lsof -i:3001; then
                  echo "âš ï¸ Port 3001 is occupied"
              else
                  echo "âš ï¸ Port 3001 is not occupied (server not running)"
              fi
              
              exit 1
          fi
        shell: bash
        timeout-minutes: 5

      - name: Validate server accessibility
        run: |
          echo "Checking login endpoint..."
          response=$(curl -s -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"Admin123!"}' \
            "http://localhost:3001/api/v1/users/login")
          
          status_code=${response: -3}
          response_body=${response%???}
          
          echo "Response code: $status_code"
          echo "Response body: $response_body"
          
          if [ "$status_code" -eq 200 ]; then
              echo "âœ… Login endpoint accessible"
          else
              echo "âŒ Login endpoint failed with status code: $status_code"
              cat "mock_server_combined.log"
              exit 1
          fi
        shell: bash

      - name: Run interface automation tests
        env:
          PYTHONIOENCODING: utf-8
          MOCK_SERVER_URL: "http://localhost:3001"
        run: |
          python run_test.py --junitxml=test-results.xml
        shell: bash

      - name: Check Allure results directory
        run: |
          # æŸ¥æ‰¾æœ€æ–°çš„æŠ¥å‘Šç›®å½•
          latest_report=$(find reports -type d -name 'report_*' | sort -r | head -n 1)
          if [ -z "$latest_report" ]; then
              echo "âŒ æ‰¾ä¸åˆ°ä»»ä½•æŠ¥å‘Šç›®å½•"
              exit 1
          fi
          
          result_dir="$latest_report/allure-results"
          if [ ! -d "$result_dir" ] || [ -z "$(ls -A $result_dir)" ]; then
              echo "âŒ Allureç»“æœç›®å½•ä¸ºç©ºæˆ–ç¼ºå¤±: $result_dir"
              exit 1
          else
              echo "âœ… Allureç»“æœæ‰¾åˆ°: $result_dir"
              # ä¿å­˜æœ€æ–°æŠ¥å‘Šè·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
              echo "LATEST_REPORT=$latest_report" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Generate Allure report
        run: |
          # ä½¿ç”¨å‰é¢ä¿å­˜çš„æœ€æ–°æŠ¥å‘Šè·¯å¾„
          allure generate "$LATEST_REPORT/allure-results" -o "$LATEST_REPORT/allure-report" --clean
          echo "âœ… AllureæŠ¥å‘Šç”ŸæˆæˆåŠŸ: $LATEST_REPORT/allure-report"
          # å¤åˆ¶æŠ¥å‘Šåˆ°æ ¹ç›®å½•publicæ–‡ä»¶å¤¹ï¼ˆæ–¹ä¾¿GitHub Pageséƒ¨ç½²ï¼‰
          mkdir -p ./public
          cp -r "$LATEST_REPORT/allure-report"/* ./public/
        shell: bash

      - name: Deploy report to GitHub Pages
        if: github.ref == 'refs/heads/master'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true

      - name: Generate public report URL
        id: report_url
        run: |
          # ç”ŸæˆGitHub Pageså…¬ç½‘è®¿é—®é“¾æ¥
          echo "::set-output name=url::https://${{ github.repository_owner }}.github.io/${{ github.repository }}/index.html"
        shell: bash

      - name: Upload test results and logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results.xml
            mock_server_combined.log
            reports/**/allure-results/
            reports/**/allure-report/
      
      - name: Stop mock server
        if: always()
        run: |
          if [ -f "mock_server.pid" ]; then
              server_pid=$(cat "mock_server.pid")
              if ps -p $server_pid > /dev/null; then
                  kill -9 $server_pid
                  echo "âœ… Mock server stopped (PID: $server_pid)"
              else
                  echo "â„¹ï¸ Mock server already stopped"
              fi
          else
              pids=$(lsof -t -i:3001 || true)
              if [ -n "$pids" ]; then
                  sudo kill -9 $pids
                  echo "âœ… Mock server stopped (found via port 3001)"
              else
                  echo "â„¹ï¸ No processes found listening on port 3001"
              fi
          fi
        shell: bash
      
      - name: Send DingTalk notification
        if: github.ref == 'refs/heads/master'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          custom_payload: |
            {
              "msgtype": "markdown",
              "markdown": {
                "title": "ğŸ“Š è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š",
                "text": "#### æµ‹è¯•ç»“æœ: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}\n" +
                        "- æäº¤ä½œè€…: ${{ github.actor }}\n" +
                        "- æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}\n" +
                        "- æ‰§è¡Œæ—¶é—´: ${{ format('{0:YYYY-MM-DD HH:mm:ss}', github.event.head_commit.timestamp) }}\n" +
                        "- æŸ¥çœ‹æŠ¥å‘Š: [ç‚¹å‡»è®¿é—®](${{ steps.report_url.outputs.url }})"
              }
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK }}
